name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  pull-requests: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Run tests
        run: make test

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Build binary
        run: make build

      - name: Set up ko
        uses: ko-build/setup-ko@v0.7

      - name: Build container image with ko
        env:
          KO_DOCKER_REPO: test
        run: |
          ko build --local --bare ./cmd

  helm:
    name: Validate Helm Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Lint Helm chart
        run: helm lint ./chart

      - name: Template Helm chart
        run: |
          helm template test-release ./chart \
            --set keycloak.url=http://keycloak:8080 \
            --set keycloak.user=admin \
            --set keycloak.password=admin \
            > /dev/null

      - name: Validate with different values
        run: |
          helm template test-release ./chart \
            -f chart/values-dev.yaml \
            > /dev/null
          
          helm template test-release ./chart \
            -f chart/values-production.yaml \
            --set keycloak.existingSecret=test-secret \
            > /dev/null
