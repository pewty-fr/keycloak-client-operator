name: Release

on:  # yamllint disable-line rule:truthy
  release:
    types:
      - published

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  detect-component:
    name: Detect Released Component
    runs-on: ubuntu-latest
    outputs:
      is_operator: ${{ steps.detect.outputs.is_operator }}
      is_chart: ${{ steps.detect.outputs.is_chart }}
      version: ${{ steps.detect.outputs.version }}
    steps:
      - name: Detect component from tag
        id: detect
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "Release tag: $TAG"
          
          # Chart releases have a prefix like "chart-v" or contain "-chart"
          if [[ "$TAG" == *"chart"* ]]; then
            echo "is_operator=false" >> $GITHUB_OUTPUT
            echo "is_chart=true" >> $GITHUB_OUTPUT
            # Extract version (remove chart prefix/suffix)
            VERSION=$(echo "$TAG" | sed -E 's/.*chart-?v?//; s/-chart.*//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Detected: Helm Chart release (version: $VERSION)"
          else
            echo "is_operator=true" >> $GITHUB_OUTPUT
            echo "is_chart=false" >> $GITHUB_OUTPUT
            # Extract version (remove v prefix if present)
            VERSION=$(echo "$TAG" | sed 's/^v//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Detected: Operator release (version: $VERSION)"
          fi

  build-and-push:
    name: Build and Push Release Image
    needs: detect-component
    if: needs.detect-component.outputs.is_operator == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install ko
        run: go install github.com/google/ko@latest

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | ko login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push with ko
        id: build
        env:
          KO_DOCKER_REPO: ghcr.io/${{ github.repository }}
        run: |
          VERSION="${{ needs.detect-component.outputs.version }}"
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f1-2)
          
          # Build and push with semantic version tags
          DIGEST=$(ko build --bare --platform=linux/amd64,linux/arm64 \
            --tags=${VERSION},${MAJOR}.${MINOR},${MAJOR},latest \
            ./cmd/main.go | grep -oP 'sha256:[a-f0-9]+')
          
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/${{ github.repository }}:${{ needs.detect-component.outputs.version }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Update release with Docker images
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.detect-component.outputs.version }}';
            const digest = '${{ steps.build.outputs.digest }}';
            const repo = '${{ github.repository }}';
            const tagName = '${{ github.event.release.tag_name }}';
            
            // Get the current release
            const release = context.payload.release;
            
            // Generate Docker images section
            const dockerSection = `
            ## ðŸ³ Docker Images

            **Available tags:**
            - \`ghcr.io/${repo}:${version}\`
            - \`ghcr.io/${repo}:latest\`

            **Image digest:** \`${digest}\`

            **Pull the image:**
            \`\`\`bash
            docker pull ghcr.io/${repo}:${version}
            \`\`\`

            **Using with Helm:**
            \`\`\`bash
            helm upgrade --install keycloak-client-operator oci://ghcr.io/${repo}-chart --version ${version}
            \`\`\`

            Or with local chart:
            \`\`\`bash
            helm upgrade --install keycloak-client-operator ./chart \\
              --set image.repository=ghcr.io/${repo} \\
              --set image.tag=${version}
            \`\`\`

            **Using with kubectl:**
            \`\`\`bash
            kubectl apply -f https://github.com/${repo}/releases/download/${tagName}/install.yaml
            \`\`\`

            **Verify the signature:**
            \`\`\`bash
            cosign verify ghcr.io/${repo}:${version} \\
              --certificate-identity-regexp="https://github.com/${repo}.*" \\
              --certificate-oidc-issuer=https://token.actions.githubusercontent.com
            \`\`\`
            `;
            
            // Update release body
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: release.body + '\n\n' + dockerSection
            });

      - name: Upload SBOM to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./sbom.spdx.json
          asset_name: sbom.spdx.json
          asset_content_type: application/json

  generate-install-manifest:
    name: Generate Installation Manifest
    needs: [detect-component, build-and-push]
    if: needs.detect-component.outputs.is_operator == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Generate installation manifest
        run: |
          helm template keycloak-client-operator ./chart \
            --set image.repository=ghcr.io/${{ github.repository }} \
            --set image.tag=${{ needs.detect-component.outputs.version }} \
            --namespace keycloak-client-operator-system \
            --create-namespace \
            > install.yaml

      - name: Upload manifest to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./install.yaml
          asset_name: install.yaml
          asset_content_type: application/x-yaml

  publish-helm-chart:
    name: Publish Helm Chart
    needs: detect-component
    if: needs.detect-component.outputs.is_chart == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Package Helm chart
        run: |
          # Chart version should already be updated by release-please
          helm package chart/

      - name: Push Helm chart to OCI registry
        run: |
          helm push keycloak-client-operator-${{ needs.detect-component.outputs.version }}.tgz \
            oci://ghcr.io/${{ github.repository_owner }}/keycloak-client-operator-chart

      - name: Update release with Helm chart info
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.detect-component.outputs.version }}';
            const owner = '${{ github.repository_owner }}';
            
            // Get the current release
            const release = context.payload.release;
            
            // Generate Helm chart section
            const helmSection = `
            ## ðŸ“¦ Helm Chart

            **Chart Version:** \`${version}\`

            **Install the chart:**
            \`\`\`bash
            helm upgrade --install keycloak-client-operator \\
              oci://ghcr.io/${owner}/keycloak-client-operator-chart \\
              --version ${version}
            \`\`\`

            **With custom values:**
            \`\`\`bash
            helm upgrade --install keycloak-client-operator \\
              oci://ghcr.io/${owner}/keycloak-client-operator-chart \\
              --version ${version} \\
              --set keycloak.url=https://keycloak.example.com \\
              --set keycloak.user=admin \\
              --set keycloak.password=secret
            \`\`\`

            **Pull the chart:**
            \`\`\`bash
            helm pull oci://ghcr.io/${owner}/keycloak-client-operator-chart --version ${version}
            \`\`\`

            **View available values:**
            \`\`\`bash
            helm show values oci://ghcr.io/${owner}/keycloak-client-operator-chart --version ${version}
            \`\`\`
            `;
            
            // Update release body
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: release.body + '\n\n' + helmSection
            });
