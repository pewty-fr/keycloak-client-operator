name: Build Snapshot

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  packages: write
  pull-requests: write

jobs:
  check-comment:
    name: Check for snapshot command
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      (github.event.comment.body == '/snapshot docker' || github.event.comment.body == '/snapshot helm')
    outputs:
      pr_number: ${{ steps.pr.outputs.number }}
      pr_sha: ${{ steps.pr.outputs.sha }}
      pr_ref: ${{ steps.pr.outputs.ref }}
      build_docker: ${{ steps.check.outputs.build_docker }}
      build_helm: ${{ steps.check.outputs.build_helm }}
    steps:
      - name: Check which snapshot to build
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            core.setOutput('build_docker', comment === '/snapshot docker' ? 'true' : 'false');
            core.setOutput('build_helm', comment === '/snapshot helm' ? 'true' : 'false');
      
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('number', pr.data.number);
            core.setOutput('sha', pr.data.head.sha);
            core.setOutput('ref', pr.data.head.ref);

      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

  build-docker-snapshot:
    name: Build and Push Docker Snapshot
    needs: check-comment
    if: needs.check-comment.outputs.build_docker == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-comment.outputs.pr_ref }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install ko
        run: go install github.com/google/ko@latest

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | ko login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push with ko
        env:
          KO_DOCKER_REPO: ghcr.io/${{ github.repository }}
        run: |
          PR_NUM=${{ needs.check-comment.outputs.pr_number }}
          SHA=${{ needs.check-comment.outputs.pr_sha }}
          
          # Build and push with multiple tags
          ko build --bare --platform=linux/amd64,linux/arm64 \
            --tags=pr-${PR_NUM}-${SHA},pr-${PR_NUM}-latest \
            ./cmd/main.go

      - name: Comment on PR with image details
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-comment.outputs.pr_number }};
            const sha = '${{ needs.check-comment.outputs.pr_sha }}';
            const shortSha = sha.substring(0, 7);
            const repo = '${{ github.repository }}';
            
            const body = `### ðŸ³ Docker Snapshot Image Built Successfully

            **Commit:** \`${shortSha}\`

            **Images:**
            - \`ghcr.io/${repo}:pr-${prNumber}-${shortSha}\`
            - \`ghcr.io/${repo}:pr-${prNumber}-latest\`

            **Docker Pull:**
            \`\`\`bash
            docker pull ghcr.io/${repo}:pr-${prNumber}-latest
            \`\`\`

            **Using with Helm:**
            \`\`\`bash
            helm upgrade --install keycloak-client-operator ./chart \\
              --set image.repository=ghcr.io/${repo} \\
              --set image.tag=pr-${prNumber}-latest
            \`\`\`

            **Using with kubectl:**
            \`\`\`bash
            kubectl set image deployment/keycloak-client-operator \\
              manager=ghcr.io/${repo}:pr-${prNumber}-latest
            \`\`\`
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  build-helm-snapshot:
    name: Build and Push Helm Snapshot
    needs: check-comment
    if: needs.check-comment.outputs.build_helm == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-comment.outputs.pr_ref }}
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Package and push Helm chart
        id: helm
        run: |
          PR_NUMBER=${{ needs.check-comment.outputs.pr_number }}
          SHA=${{ needs.check-comment.outputs.pr_sha }}
          SHORT_SHA=${SHA:0:7}
          VERSION="0.0.0-pr${PR_NUMBER}-${SHORT_SHA}"
          
          # Update chart version for snapshot
          sed -i "s/version: .*/version: ${VERSION}/" chart/Chart.yaml
          sed -i "s/appVersion: .*/appVersion: \"pr-${PR_NUMBER}-latest\"/" chart/Chart.yaml
          
          # Package the chart
          helm package chart/
          
          # Push to OCI registry with -chart suffix
          helm push keycloak-client-operator-${VERSION}.tgz oci://ghcr.io/${{ github.repository_owner }}/keycloak-client-operator-chart
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Comment on PR with Helm details
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-comment.outputs.pr_number }};
            const sha = '${{ needs.check-comment.outputs.pr_sha }}';
            const shortSha = sha.substring(0, 7);
            const version = '${{ steps.helm.outputs.version }}';
            const owner = '${{ github.repository_owner }}';
            
            const body = `### ðŸ“¦ Helm Snapshot Chart Built Successfully

            **Commit:** \`${shortSha}\`
            **Chart Version:** \`${version}\`

            **Install the chart:**
            \`\`\`bash
            helm upgrade --install keycloak-client-operator \\
              oci://ghcr.io/${owner}/keycloak-client-operator-chart \\
              --version ${version}
            \`\`\`

            **With custom values:**
            \`\`\`bash
            helm upgrade --install keycloak-client-operator \\
              oci://ghcr.io/${owner}/keycloak-client-operator-chart \\
              --version ${version} \\
              --set keycloak.url=https://keycloak.example.com \\
              --set keycloak.user=admin \\
              --set keycloak.password=secret
            \`\`\`

            **Pull the chart:**
            \`\`\`bash
            helm pull oci://ghcr.io/${owner}/keycloak-client-operator-chart --version ${version}
            \`\`\`
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
